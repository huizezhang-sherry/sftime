---
title: "Introduction to sftime"
author: "Benedikt GrÃ¤ler, Edzer Pebesma"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to sftime}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The package sftime extends the package sf to store and handle spatiotemporal data. To this end, sftime introduces a dedicated time column which stores the temporal information alongside the simple features column of sf objects. 

The time column can consists of any collection of a class that allows to be sorted - reflecting the native order of time. Besides well-known time classes such as `Date` or `POSIXct`, it also allows for custom class definitions, that provide the necessary dedicated functions to make the sorting procedures work (we will see a example below).

This vignette is meant to briefly explain and illustrate the ideas and decisions behind the implementations of sftime.

```{r packages}
# load required packages
library(sftime)
library(sf)
library(stars)
library(spacetime)
```


## The `sftime` class

An `sftime` object is an `sf` object with an additional time column which contains the temporal information alongside the simple features column. This allows it to handle irregular and regular temporal information.

For spatiotemporal data with regular temporal data, the package stars is developed as a powerful alternative (e.g. time series of remote sensing imagery, regular measurements of entire measurement network).

`sftime` objects can be constructed directly from `sfc` objects by combining them with a vector representing temporal information:

```{r sftime-class-1}
# example sfc object
x_sfc <- 
  sf::st_sfc(
    sf::st_point(1:2), 
    sf::st_point(c(1,3)), 
    sf::st_point(2:3), 
    sf::st_point(c(2,1))
  )

# create an sftime object directly from x_sfc
x_sftime1 <- sftime::st_sftime(a = 1:4, x_sfc, time = Sys.time()- 0:3 * 3600 * 24)

# first create the sf object and from this the sftime object
x_sf <- sf::st_sf(a = 1:4, x_sfc, time = x_sftime1$time)
x_sftime2 <- sftime::st_sftime(x_sf)

x_sftime3 <- sftime::st_as_sftime(x_sf) # alernative option

identical(x_sftime1, x_sftime2)
identical(x_sftime1, x_sftime3)

x_sftime1
```

Functions to get or set the time column of an `sftime` object.

```{r sftime-class-2}
# get the values from the time column
st_time(x_sftime1)

# set the values in the time column
st_time(x_sftime1) <- Sys.time()
st_time(x_sftime1)

# drop the time column to convert an sftime object to an sf object
st_drop_time(x_sftime1)
x_sftime1

# add a time column to an sf object converts it to an sftime object
st_time(x_sftime1, time_column_name = "time") <- Sys.time()
class(x_sftime1)

# These can also be used with pipes
x_sftime1 <-
  x_sftime1 %>%
  st_drop_time() %>%
  st_set_time(Sys.time(), time_column_name = "time")
```


## Conversion to class `sftime`

sftime supports coercion to `sftime` objects from the following classes (grouped according to packages):

- sf: sf
- stars: stars
- spacetime: STI, STIDF
- trajectories: Track, Tracks, TracksCollection
- sftrack: sftrack, sftraj

**Conversion from `sf` objects:**

```{r}
# define the geometry column
g <- 
  st_sfc(
    st_point(c(1, 2)), 
    st_point(c(1, 3)), 
    st_point(c(2, 3)), 
    st_point(c(2, 1)), 
    st_point(c(3, 1))
  )

# crate sf object
x4_sf <- st_sf(a = 1:5, g, time = Sys.time() + 1:5)

# convert to sftime
x4_sftime <- st_as_sftime(x4_sf) 
class(x4_sftime)
```

**Conversion from `stars` objects:**

```{r}
# load sample data
x5_stars <- stars::read_ncdf(system.file("nc/bcsd_obs_1999.nc", package = "stars"), var = c("pr", "tas"))

# convert to sftime
x5_sftime <- st_as_sftime(x5_stars, time_column_name = "time")
```

`st_as_sftime.stars` is a wrapper around `st_as_sf.stars`. As a consequence, some dimensions of the `stars` object can be dropped during conversion. Temporal information in `stars` objects are typically stored as dimension of an attribute. Therefore, some argument settings to `st_as_sftime` can drop the dimension with temporal information and therefore throw an error. For example, setting `merge = TRUE` drops dimension `time` and therefore conversion fails. Similarly, setting `long = FALSE` returns the attribute values in a wide format, where each column is a time point:

```{r, error = TRUE}
# failed conversion to sftime
x5_sftime <- st_as_sftime(x5_stars, merge = TRUE, time_column_name = "time")
x5_sftime <- st_as_sftime(x5_stars, long = FALSE, time_column_name = "time")
```

**Conversion from `spacetime` objects**

```{r}
# get sample data
example(STI, package = "spacetime")
class(stidf)

# conversion to sftime
x1_sftime <- st_as_sftime(stidf)
```

**Conversion from `Track`, `Tracks`, `TracksCollections` objects (trajectories package)**

```{r}
# get a sample TracksCollection
x2_TracksCollection <- trajectories::rTracksCollection(p = 2, m = 3, n = 40)

# convert to sftime
x2_TracksCollection_sftime <- st_as_sftime(x2_TracksCollection)
x2_Tracks_sftime <- st_as_sftime(x2_TracksCollection@tracksCollection[[1]])
x2_Track_sftime <- st_as_sftime(x2_TracksCollection@tracksCollection[[1]]@tracks[[1]])
```


## Subsetting

Different subsetting methods exist for `sftime` objects. Since `sftime` objects are built on top of `sf` objects, all subsetting methods for `sf` objects also work for `sftime` objects.


## Plotting
One of the first thing to do after a data set has been created, is to inspect it by plotting it. 
Plotting an 3+ dimensional object is always a projection of selected dimensions. 
The following plotting abilities are provided in `sftime` through the mode argument (just as in `spacetime::stplot`). Depending on the nature of the data/underlying processes, some options might not lead to useful visualizations:

  - `"xy"`: maps for time ranges are plotted, ranges can be defined or will be equally distributed. Geometries might be overlaid several times when multiple times fall in the same selected range.
  - `"xt"`: a space-time plot is constructed, this might lead to a straight line along the main diagonal in case not two geometries are recorded for the same time stamp nor are geometries recorded more than once. 
  - `"ts"`: multiple-locations time series are plotted in a single plot, or in a separate panel for each attribute
  - `"tp"`: single- or multi-attribute time series are plotted in multiple panels, one panel per location.
  
Examples for `mode="xy"`, the default:

```{r, fig.width=7}
coords <- matrix(runif(100), ncol = 2)
g = st_sfc(lapply(1:50, function(i) st_point(coords[i,]) ))
sft <- st_sftime(a=1:50, g, time = as.POSIXct("2020-09-01 00:00:00") + 0:49 * 3600 * 6)

plot(sft, key.pos = 4)

plot(sft, number = 10, max.plot = 10)

```



# Old stuff

## The time column

The time column is a special column of the underlying sf object which defines time information (timestamps and temporal ordering) alongside the simple features column of an sf object. Common time representations in R (e.g. "POSIXct", "POSIXlt", "Date", "yearmon", "yearqtr", "factor") are allowed, as well as optional user defined types. Lets look at a simple example where we define a time column based on "POSIXct"

```{r, eval=FALSE}
library(sftime)
tc <- st_tc(as.POSIXct("2020-09-01 08:00:00")-0:3*3600*24)

tc
```

The ordering is not altered upon construction (as in some other representations). If a different order is required, the "order" and "sort" functions can be applied to the time column:

```{r, eval=FALSE}
tc[1]

order(tc)

sort(tc)
```

In some applications it might be useful to have more complex temporal information such as intervals of different length. The following example is also meant as template for other user defined classes which could be used to build the time column of the sftime class.

At first, we will need a few helper functions:

```{r, eval=FALSE}
# utility functions
as.character.interval <- function(x) {
  paste0("[", x[1], ", ", x[2], "]")
}

print.interval<- function(x) {
  cat("Interval:", as.character(x))
}

'[.intervals' <- function(x, i) {
  sx <- unclass(x)[i]
  class(sx) <- "intervals"
  sx
}
```

Now, we can define the different intervals used to represent our temporal information:

```{r, eval=FALSE}
# time interval definition
i1 <- c(5.3,12)
class(i1) <- "interval"
i2 <- c(3.1,6)
class(i2) <- "interval"
i3 <- c(1.4,6.9)
class(i3) <- "interval"
i4 <- c(1,21)
class(i4) <- "interval"

intrvls <- list(i1, i2, i3, i4)
class(intrvls) <- c("intervals", class(intrvls))
# provide dedicated generic to xtfrm for class intervals
xtfrm.intervals <- function(is) sapply(is, xtfrm)
```

The advantage is to be able to define different sorting approaches:

```{r, eval=FALSE}
# - sort by centre
xtfrm.interval <- function(i) mean(i)

tc <- st_tc(intrvls)
tc
tc[1]
order(tc)
sort(tc)[1]
```

```{r, eval=FALSE}
# - sort by end
xtfrm.interval <- function(i) i[2]
tc <- st_tc(intrvls)
tc
tc[1]
order(tc)
sort(tc)[1]
```

```{r, eval=FALSE}
# - sort by start
xtfrm.interval <- function(i) i[1]

tc <- st_tc(intrvls)
tc
tc[1]
order(tc)
sort(tc)[1]
```

Based on the sorting procedure (begin, centre or end of the interval), the smallest element (each last line) and the order of the time column changes.

## The sftime class

An `sftime` object is an `sf` object with an additional time column which contains the temporal information alongside the simple features column. This allows it to handle irregular and regular temporal information.

For spatiotemporal data with regular temporal data, the package stars is developed as a powerful alternative (e.g. time series of remote sensing imagery, regular measurements of entire measurement network).

sftime objects can be constructed based on sf objects:

```{r, eval=FALSE}

g = st_sfc(st_point(1:2), st_point(c(1,3)), st_point(2:3), st_point(c(2,1)))

# provide as.data.frame method. This is needed for sf::st_sf to not cause an error with lists when calling as.data.frame
as.data.frame.intervals <- function(x, ...) {
  nm <- deparse1(substitute(x))
  if (!"nm" %in% names(list(...))) 
    as.data.frame.vector(x, ..., nm = nm)
  else as.data.frame.vector(x, ...)
}

sft <- st_sftime(a = 1:4, g, time = sort(tc))

sft <- st_sftime(g, time = st_tc(Sys.time()-0:3*3600*24))
```

This is the very beginning there is more to come.

## coercion

## sub-setting

## plotting
One of the first thing to do after a data set has been created, is to inspect it by plotting it. 
Plotting an 3+ dimensional onject is always a projection of selected dimensions. 
The following plotting abilities are provided in `sftime` through the mode argument (just as in `spacetime::stplot`). Depending on the nature of the data/underlying processes, some options might not lead to useful visulaisations:

  - `"xy"`: maps for time ranges are plotted, ranges can be defined or will be equally distributed. Geometries might be overlaid several times when multiple times fall in the same selected range.
  - `"xt"`: a space-time plot is constructed, this might lead to a straight line along the main diagonal in case not two geometries are recorded for the same time stamp nor are geometries recorded more than once. 
  - `"ts"`: multiple-locations time series are plotted in a single plot, or in a separate panel for each attribute
  - `"tp"`: single- or multi-attribute time series are plotted in multiple panels, one panel per location.
  
Examples for `mode="xy"`, the default:

```{r, fig.width=7, eval=FALSE}
coords <- matrix(runif(100), ncol = 2)
g = st_sfc(lapply(1:50, function(i) st_point(coords[i,]) ))
sf <- st_sf(a=1:50, g)

sft <- st_sftime(cbind(sf, time = st_tc(as.POSIXct("2020-09-01 00:00:00")+0:49*3600*6)))

plot(sft, key.pos = 4)

plot(sft, number=10, max.plot=10)

```
